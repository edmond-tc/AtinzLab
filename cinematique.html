<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SimLab â€” CinÃ©matique</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0e1a;--surface:#111827;--surface2:#1a2540;--surface3:#1f2d4a;
  --border:#2a3a5c;--cyan:#00e5ff;--cyan-glow:rgba(0,229,255,0.15);
  --green:#00ff88;--orange:#ff8c00;--red:#ff4444;--purple:#c084fc;
  --text:#e2e8f0;--text-dim:#8898b0;--text-mute:#4a5568;
  --font:'Outfit',sans-serif;--mono:'JetBrains Mono',monospace;
  --radius:12px;--radius-sm:8px;--shadow:0 4px 24px rgba(0,0,0,.5);
  --header-h:56px;--panel-h:300px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font);overflow:hidden}

/* â”€â”€ HEADER â”€â”€ */
#header{position:fixed;top:0;left:0;right:0;height:var(--header-h);
  background:rgba(10,14,26,.96);border-bottom:1px solid var(--border);
  backdrop-filter:blur(14px);display:flex;align-items:center;gap:8px;
  padding:0 12px;z-index:100;overflow-x:auto;scrollbar-width:none}
#header::-webkit-scrollbar{display:none}
#btn-back{display:flex;align-items:center;gap:5px;background:var(--surface2);
  border:1px solid var(--border);color:var(--text-dim);padding:6px 10px;
  border-radius:var(--radius-sm);font-family:var(--font);font-size:12px;
  cursor:pointer;text-decoration:none;transition:all .2s;white-space:nowrap;flex-shrink:0}
#btn-back:hover{color:var(--cyan);border-color:var(--cyan)}
#hlogo{font-size:13px;font-weight:600;color:var(--cyan);white-space:nowrap;
  display:flex;align-items:center;gap:5px;flex-shrink:0}
#hlogo span{color:var(--text-dim);font-weight:400;font-size:11px}
#hsep{flex:1;min-width:4px}
#header-modes{display:flex;gap:3px;flex-shrink:0}
.mode-btn{padding:5px 9px;border-radius:6px;border:1px solid var(--border);
  background:transparent;color:var(--text-dim);font-family:var(--font);
  font-size:11px;cursor:pointer;transition:all .2s;white-space:nowrap}
.mode-btn.active{background:var(--cyan-glow);border-color:var(--cyan);color:var(--cyan)}
#view-toggle{display:flex;background:var(--surface2);border:1px solid var(--border);
  border-radius:6px;overflow:hidden;flex-shrink:0}
.view-btn{padding:5px 10px;border:none;background:transparent;
  color:var(--text-dim);font-family:var(--mono);font-size:11px;cursor:pointer;transition:all .2s}
.view-btn.active{background:var(--cyan-glow);color:var(--cyan)}
#lang-btn{padding:5px 9px;border-radius:6px;border:1px solid var(--border);
  background:transparent;color:var(--text-dim);font-family:var(--mono);
  font-size:11px;cursor:pointer;flex-shrink:0;transition:all .2s}
#lang-btn:hover{color:var(--cyan);border-color:var(--cyan)}

/* â”€â”€ LAYOUT â”€â”€ */
#app{position:fixed;top:var(--header-h);left:0;right:0;bottom:var(--panel-h);overflow:hidden}
#canvas-wrap{position:relative;width:100%;height:100%;overflow:hidden;background:var(--surface)}
#simCanvas{display:block;width:100%;height:100%;touch-action:none}
#threeCanvas{display:none;width:100%;height:100%;touch-action:none;position:absolute;top:0;left:0}
#canvas-wrap.mode2d::before{content:'';position:absolute;inset:0;pointer-events:none;
  background-image:linear-gradient(rgba(42,58,92,.28) 1px,transparent 1px),
    linear-gradient(90deg,rgba(42,58,92,.28) 1px,transparent 1px);
  background-size:50px 50px;z-index:1}

/* â”€â”€ HUD badges â”€â”€ */
#sim-badge{position:absolute;top:12px;left:12px;z-index:5;
  background:rgba(17,24,39,.9);border:1px solid var(--border);
  border-radius:8px;padding:8px 12px;font-family:var(--mono);
  font-size:11px;backdrop-filter:blur(8px)}
#sim-time{color:var(--cyan);font-weight:700;font-size:14px;display:block}
#sim-label{font-size:10px;color:var(--text-mute)}
#view-info{position:absolute;top:12px;right:12px;z-index:5;display:none;
  background:rgba(17,24,39,.85);border:1px solid var(--border);
  border-radius:6px;padding:5px 10px;font-size:10px;color:var(--text-mute);font-family:var(--mono)}
#mode-badge{position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:5;
  background:rgba(17,24,39,.85);border:1px solid var(--border);
  border-radius:20px;padding:4px 14px;font-size:11px;font-weight:600;
  color:var(--purple);font-family:var(--mono);letter-spacing:.04em;display:none}

/* â”€â”€ RESULTS PANEL â”€â”€ */
#results-panel{position:absolute;bottom:24px;right:12px;z-index:10;width:215px;
  background:rgba(17,24,39,.96);border:1px solid var(--border);border-radius:var(--radius);
  backdrop-filter:blur(14px);padding:14px;
  transform:translateX(calc(100% + 24px));
  transition:transform .4s cubic-bezier(.34,1.56,.64,1);
  box-shadow:var(--shadow),0 0 30px rgba(0,229,255,.06)}
#results-panel.visible{transform:translateX(0)}
#results-panel h3{font-size:11px;font-weight:600;color:var(--cyan);
  letter-spacing:.08em;text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.result-row{display:flex;justify-content:space-between;align-items:center;
  padding:5px 0;border-bottom:1px solid rgba(42,58,92,.5);font-size:12px}
.result-row:last-child{border-bottom:none}
.result-label{color:var(--text-dim)}
.result-value{font-family:var(--mono);font-size:12px;color:var(--cyan);font-weight:500}

/* â”€â”€ VECTOR LEGEND â”€â”€ */
#vector-legend{position:absolute;bottom:16px;left:12px;z-index:5;
  background:rgba(17,24,39,.85);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:8px 12px;font-size:11px}
.vleg-row{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.vleg-row:last-child{margin-bottom:0}
.vleg-line{width:20px;height:3px;border-radius:2px}
.vleg-label{color:var(--text-dim)}

/* â”€â”€ TIMELINE â”€â”€ */
#timeline{position:absolute;bottom:0;left:0;right:0;height:4px;background:var(--surface2);z-index:6}
#timeline-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--green));
  width:0%;transition:width .05s linear;box-shadow:0 0 8px var(--cyan)}

/* â”€â”€ PARTICLES â”€â”€ */
#particles-layer{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:8}
.particle{position:absolute;border-radius:50%;pointer-events:none;animation:prise 1s ease-out forwards}
@keyframes prise{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0)}}

/* â”€â”€ BOTTOM PANEL â”€â”€ */
#ctrl-panel{position:fixed;bottom:0;left:0;right:0;height:var(--panel-h);
  background:var(--surface);border-top:1px solid var(--border);
  display:flex;flex-direction:column;z-index:50;transition:height .3s ease}
#ctrl-panel.collapsed{height:44px}
#tabs-bar{display:flex;align-items:center;height:44px;border-bottom:1px solid var(--border);
  flex-shrink:0;padding:0 8px;gap:2px;overflow-x:auto;scrollbar-width:none}
#tabs-bar::-webkit-scrollbar{display:none}
.tab-btn{flex-shrink:0;display:flex;align-items:center;gap:5px;padding:0 12px;height:36px;
  border-radius:var(--radius-sm);border:none;background:transparent;color:var(--text-dim);
  font-family:var(--font);font-size:12px;cursor:pointer;transition:all .2s;white-space:nowrap}
.tab-btn.active{background:var(--cyan-glow);color:var(--cyan)}
.tab-btn:hover:not(.active){color:var(--text);background:rgba(255,255,255,.04)}
#tabs-collapse{margin-left:auto;flex-shrink:0;width:30px;height:30px;border-radius:6px;
  border:1px solid var(--border);background:transparent;color:var(--text-dim);
  cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s}
#tabs-collapse:hover{color:var(--cyan);border-color:var(--cyan)}
#action-bar{display:flex;gap:8px;padding:8px 12px;flex-shrink:0}
.action-btn{flex:1;height:40px;border-radius:var(--radius-sm);border:1px solid transparent;
  font-family:var(--font);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;
  display:flex;align-items:center;justify-content:center;gap:5px}
#btn-launch{background:linear-gradient(135deg,#00ff88,#00cc66);color:#003320;
  border-color:#00ff88;box-shadow:0 0 16px rgba(0,255,136,.25)}
#btn-launch:hover{box-shadow:0 0 26px rgba(0,255,136,.5);transform:translateY(-1px)}
#btn-pause{background:var(--surface2);color:var(--text-dim);border-color:var(--border)}
#btn-pause:hover{color:var(--orange);border-color:var(--orange)}
#btn-pause.paused{color:var(--cyan);border-color:var(--cyan)}
#btn-reset{background:var(--surface2);color:var(--text-dim);border-color:var(--border)}
#btn-reset:hover{color:var(--red);border-color:var(--red)}
#tabs-content{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
#tabs-content::-webkit-scrollbar{width:4px}
#tabs-content::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.tab-pane{display:none;padding:12px}
.tab-pane.active{display:block}

/* â”€â”€ PARAMS â”€â”€ */
.params-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(min-width:600px){.params-grid{grid-template-columns:repeat(3,1fr)}}
@media(min-width:900px){.params-grid{grid-template-columns:repeat(4,1fr)}}
.param-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px}
.param-label{font-size:11px;color:var(--text-dim);margin-bottom:6px;font-weight:500;display:flex;justify-content:space-between}
.param-label span{font-family:var(--mono);font-size:11px;color:var(--cyan);font-weight:600}
.param-slider{-webkit-appearance:none;appearance:none;width:100%;height:4px;background:var(--border);border-radius:2px;outline:none;cursor:pointer}
.param-slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--cyan);border:3px solid var(--surface);cursor:pointer;box-shadow:0 0 8px rgba(0,229,255,.5)}
.param-slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--cyan);border:3px solid var(--surface);cursor:pointer}

/* â”€â”€ MESURES â”€â”€ */
.mesures-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(min-width:600px){.mesures-grid{grid-template-columns:repeat(4,1fr)}}
.mesure-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;text-align:center}
.mesure-icon{font-size:18px;margin-bottom:4px}
.mesure-name{font-size:11px;color:var(--text-dim);margin-bottom:4px}
.mesure-val{font-family:var(--mono);font-size:15px;color:var(--cyan);font-weight:700}
.mesure-unit{font-size:10px;color:var(--text-mute)}

/* â”€â”€ LOIS â”€â”€ */
.lois-container{display:flex;flex-direction:column;gap:10px}
.loi-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden}
.loi-header{display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;transition:background .2s}
.loi-header:hover{background:rgba(0,229,255,.04)}
.loi-header h4{font-size:12px;font-weight:600;flex:1}
.loi-tag{font-size:10px;padding:3px 8px;border-radius:20px;background:var(--cyan-glow);color:var(--cyan);font-family:var(--mono)}
.loi-chevron{color:var(--text-dim);transition:transform .2s;font-size:11px}
.loi-card.open .loi-chevron{transform:rotate(180deg)}
.loi-body{display:none;padding:0 14px 14px}
.loi-card.open .loi-body{display:block}
.formula-box{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin-bottom:8px;font-family:var(--mono);font-size:13px;color:var(--cyan);text-align:center}
.loi-desc{font-size:12px;color:var(--text-dim);line-height:1.6}
.loi-variables{margin-top:8px}
.loi-variables p{font-size:11px;color:var(--text-dim);margin-bottom:3px;font-family:var(--mono)}
.loi-variables p b{color:var(--purple)}

/* â”€â”€ RAPPORT â”€â”€ */
.rapport-section{display:flex;flex-direction:column;gap:8px}
.rapport-info{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px}
.rapport-info p{font-size:12px;color:var(--text-dim);line-height:1.6}
.rapport-btns{display:flex;gap:8px;flex-wrap:wrap}
.rapport-btn{flex:1;min-width:120px;padding:10px 12px;border-radius:var(--radius-sm);
  border:1px solid var(--border);background:var(--surface2);color:var(--text-dim);
  font-family:var(--font);font-size:12px;cursor:pointer;transition:all .2s;
  display:flex;align-items:center;justify-content:center;gap:6px}
.rapport-btn:hover{color:var(--cyan);border-color:var(--cyan);background:var(--cyan-glow)}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:calc(var(--panel-h) + 12px);left:50%;
  transform:translateX(-50%) translateY(20px);background:var(--surface2);
  border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:10px 20px;font-size:13px;font-weight:500;white-space:nowrap;
  opacity:0;pointer-events:none;transition:all .3s;z-index:200;box-shadow:var(--shadow)}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
#toast.toast-success{border-color:var(--green);color:var(--green)}
#toast.toast-info{border-color:var(--cyan);color:var(--cyan)}
#toast.toast-warn{border-color:var(--orange);color:var(--orange)}
#toast.toast-error{border-color:var(--red);color:var(--red)}

@media(max-width:480px){:root{--panel-h:320px;--header-h:50px}#hlogo span{display:none}.tab-btn{padding:0 8px}}
@media(min-width:768px){:root{--panel-h:280px}}
</style>
</head>
<body>

<!-- HEADER -->
<header id="header">
  <a id="btn-back" href="index.html">â† <span id="txt-back">Retour</span></a>
  <div id="hlogo">âš—ï¸ SimLab <span>atinzlab.pages.dev</span></div>
  <div id="hsep"></div>
  <div id="header-modes">
    <button class="mode-btn" data-mode="mru">MRU</button>
    <button class="mode-btn" data-mode="mrua">MRUA</button>
    <button class="mode-btn active" data-mode="proj">Projectile</button>
    <button class="mode-btn" data-mode="circ">Circulaire</button>
  </div>
  <div id="view-toggle">
    <button class="view-btn active" data-view="2d">2D</button>
    <button class="view-btn" data-view="3d">3D</button>
  </div>
  <button id="lang-btn">EN</button>
</header>

<!-- SIMULATION ZONE -->
<main id="app">
  <div id="canvas-wrap" class="mode2d">
    <canvas id="simCanvas"></canvas>
    <canvas id="threeCanvas"></canvas>
    <div id="particles-layer"></div>
    <div id="sim-badge"><span id="sim-time">0.00 s</span><span id="sim-label">Temps</span></div>
    <div id="view-info"></div>
    <div id="mode-badge"></div>
    <div id="results-panel">
      <h3>ğŸ“Š <span id="txt-res-title">RÃ©sultats</span></h3>
      <div class="result-row"><span class="result-label" id="rl-x">Position x</span><span class="result-value" id="res-x">â€”</span></div>
      <div class="result-row"><span class="result-label" id="rl-y">Position y</span><span class="result-value" id="res-y">â€”</span></div>
      <div class="result-row"><span class="result-label" id="rl-v">Vitesse</span><span class="result-value" id="res-v">â€”</span></div>
      <div class="result-row"><span class="result-label" id="rl-a">AccÃ©lÃ©ration</span><span class="result-value" id="res-a">â€”</span></div>
      <div class="result-row"><span class="result-label" id="rl-t">Temps</span><span class="result-value" id="res-t">â€”</span></div>
      <div class="result-row" id="res-row-r"><span class="result-label" id="rl-r">PortÃ©e</span><span class="result-value" id="res-r">â€”</span></div>
    </div>
    <div id="vector-legend">
      <div class="vleg-row"><div class="vleg-line" style="background:#00e5ff"></div><span class="vleg-label" id="vl-v">Vecteur vitesse</span></div>
      <div class="vleg-row"><div class="vleg-line" style="background:#ff8c00"></div><span class="vleg-label" id="vl-a">Vecteur accÃ©l.</span></div>
      <div class="vleg-row"><div class="vleg-line" style="background:#c084fc"></div><span class="vleg-label" id="vl-t">Trajectoire</span></div>
    </div>
    <div id="timeline"><div id="timeline-fill"></div></div>
  </div>
</main>

<!-- CONTROL PANEL -->
<div id="ctrl-panel">
  <div id="tabs-bar">
    <button class="tab-btn active" data-tab="params">âš™ï¸ <span id="tt-p">ParamÃ¨tres</span></button>
    <button class="tab-btn" data-tab="mesures">ğŸ“ <span id="tt-m">Mesures</span></button>
    <button class="tab-btn" data-tab="lois">ğŸ“š <span id="tt-l">Lois</span></button>
    <button class="tab-btn" data-tab="rapport">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      <span id="tt-r">Rapport TP</span>
    </button>
    <button id="tabs-collapse">â–¼</button>
  </div>
  <div id="action-bar">
    <button class="action-btn" id="btn-launch">â–¶ <span id="txt-launch">Lancer</span></button>
    <button class="action-btn" id="btn-pause">â¸ <span id="txt-pause">Pause</span></button>
    <button class="action-btn" id="btn-reset">â†º <span id="txt-reset">Reset</span></button>
  </div>
  <div id="tabs-content">

    <!-- PARAMS -->
    <div class="tab-pane active" id="tab-params">
      <div class="params-grid">
        <div class="param-card"><div class="param-label"><span id="lbl-v0">Vit. initiale vâ‚€</span><span id="val-v0">15 m/s</span></div><input type="range" class="param-slider" id="sl-v0" min="1" max="50" value="15" step="0.5"></div>
        <div class="param-card" id="card-angle"><div class="param-label"><span id="lbl-angle">Angle Î¸</span><span id="val-angle">45Â°</span></div><input type="range" class="param-slider" id="sl-angle" min="0" max="90" value="45" step="1"></div>
        <div class="param-card" id="card-a"><div class="param-label"><span id="lbl-acc">AccÃ©l. a</span><span id="val-a">2 m/sÂ²</span></div><input type="range" class="param-slider" id="sl-a" min="-20" max="20" value="2" step="0.5"></div>
        <div class="param-card" id="card-g"><div class="param-label"><span id="lbl-g">GravitÃ© g</span><span id="val-g">9.81 m/sÂ²</span></div><input type="range" class="param-slider" id="sl-g" min="0" max="25" value="9.81" step="0.01"></div>
        <div class="param-card"><div class="param-label"><span id="lbl-mass">Masse m</span><span id="val-mass">1 kg</span></div><input type="range" class="param-slider" id="sl-mass" min="0.1" max="10" value="1" step="0.1"></div>
        <div class="param-card" id="card-h0"><div class="param-label"><span id="lbl-h0">Hauteur hâ‚€</span><span id="val-h0">0 m</span></div><input type="range" class="param-slider" id="sl-h0" min="0" max="50" value="0" step="0.5"></div>
        <div class="param-card" id="card-r"><div class="param-label"><span id="lbl-r">Rayon r</span><span id="val-r">5 m</span></div><input type="range" class="param-slider" id="sl-r" min="1" max="12" value="5" step="0.1"></div>
        <div class="param-card"><div class="param-label"><span id="lbl-speed">Vitesse sim.</span><span id="val-speed">1.0Ã—</span></div><input type="range" class="param-slider" id="sl-speed" min="0.1" max="3" value="1" step="0.1"></div>
      </div>
    </div>

    <!-- MESURES -->
    <div class="tab-pane" id="tab-mesures">
      <div class="mesures-grid">
        <div class="mesure-card"><div class="mesure-icon">ğŸ“</div><div class="mesure-name" id="ml-x">Position X</div><div class="mesure-val" id="mv-x">â€”</div><div class="mesure-unit">m</div></div>
        <div class="mesure-card"><div class="mesure-icon">ğŸ“</div><div class="mesure-name" id="ml-y">Position Y</div><div class="mesure-val" id="mv-y">â€”</div><div class="mesure-unit">m</div></div>
        <div class="mesure-card"><div class="mesure-icon">âš¡</div><div class="mesure-name" id="ml-vx">Vitesse Vx</div><div class="mesure-val" id="mv-vx">â€”</div><div class="mesure-unit">m/s</div></div>
        <div class="mesure-card"><div class="mesure-icon">âš¡</div><div class="mesure-name" id="ml-vy">Vitesse Vy</div><div class="mesure-val" id="mv-vy">â€”</div><div class="mesure-unit">m/s</div></div>
        <div class="mesure-card"><div class="mesure-icon">ğŸƒ</div><div class="mesure-name" id="ml-v">|Vitesse|</div><div class="mesure-val" id="mv-v">â€”</div><div class="mesure-unit">m/s</div></div>
        <div class="mesure-card"><div class="mesure-icon">â±ï¸</div><div class="mesure-name" id="ml-t">Temps</div><div class="mesure-val" id="mv-t">â€”</div><div class="mesure-unit">s</div></div>
        <div class="mesure-card"><div class="mesure-icon">ğŸ“</div><div class="mesure-name" id="ml-d">Distance</div><div class="mesure-val" id="mv-d">â€”</div><div class="mesure-unit">m</div></div>
        <div class="mesure-card"><div class="mesure-icon">ğŸ”‹</div><div class="mesure-name" id="ml-ec">Ã‰c. cinÃ©tique</div><div class="mesure-val" id="mv-ec">â€”</div><div class="mesure-unit">J</div></div>
      </div>
    </div>

    <!-- LOIS -->
    <div class="tab-pane" id="tab-lois">
      <div class="lois-container">
        <div class="loi-card" id="loi-mru">
          <div class="loi-header" onclick="toggleLoi(this)"><h4>ğŸ“ MRU â€” Mouvement Rectiligne Uniforme</h4><span class="loi-tag">v = cte</span><span class="loi-chevron">â–¼</span></div>
          <div class="loi-body">
            <div class="formula-box">x(t) = xâ‚€ + v Â· t</div>
            <p class="loi-desc">En MRU, la vitesse est <strong>constante</strong> : l'accÃ©lÃ©ration est nulle. L'objet parcourt des distances Ã©gales en des temps Ã©gaux. Le graphe x(t) est une <em>droite</em>. Cas rÃ©el : vÃ©hicule sur autoroute Ã  vitesse stabilisÃ©e.</p>
            <div class="loi-variables"><p><b>x(t)</b> â€” position Ã  l'instant t (m)</p><p><b>xâ‚€</b> â€” position initiale (m)</p><p><b>v</b> â€” vitesse constante (m/s)</p></div>
          </div>
        </div>
        <div class="loi-card" id="loi-mrua">
          <div class="loi-header" onclick="toggleLoi(this)"><h4>ğŸš€ MRUA â€” Mouvement Rectiligne UniformÃ©ment AccÃ©lÃ©rÃ©</h4><span class="loi-tag">a = cte</span><span class="loi-chevron">â–¼</span></div>
          <div class="loi-body">
            <div class="formula-box">x(t) = xâ‚€ + vâ‚€Â·t + Â½Â·aÂ·tÂ²</div>
            <div class="formula-box">v(t) = vâ‚€ + aÂ·t</div>
            <div class="formula-box">vÂ² = vâ‚€Â² + 2Â·aÂ·(x âˆ’ xâ‚€)</div>
            <p class="loi-desc">L'accÃ©lÃ©ration est constante. La vitesse varie <strong>linÃ©airement</strong>. Le graphe x(t) est une <em>parabole</em>. Cas rÃ©els : freinage d'une voiture, chute libre, dÃ©marrage d'un train.</p>
            <div class="loi-variables"><p><b>a</b> â€” accÃ©lÃ©ration (m/sÂ²)</p><p><b>vâ‚€</b> â€” vitesse initiale (m/s)</p></div>
          </div>
        </div>
        <div class="loi-card open" id="loi-proj">
          <div class="loi-header" onclick="toggleLoi(this)"><h4>ğŸ¯ Tir Parabolique â€” Projectile en champ gravitationnel</h4><span class="loi-tag">2D</span><span class="loi-chevron">â–¼</span></div>
          <div class="loi-body">
            <div class="formula-box">x(t) = vâ‚€Â·cos(Î¸)Â·t</div>
            <div class="formula-box">y(t) = hâ‚€ + vâ‚€Â·sin(Î¸)Â·t âˆ’ Â½Â·gÂ·tÂ²</div>
            <div class="formula-box">PortÃ©e : R = vâ‚€Â²Â·sin(2Î¸) / g</div>
            <div class="formula-box">H_max = hâ‚€ + vâ‚€Â²Â·sinÂ²(Î¸) / (2g)</div>
            <p class="loi-desc">DÃ©composition : axe horizontal (MRU) + axe vertical (MRUA). Angle optimal pour portÃ©e maximale : <strong>Î¸ = 45Â°</strong>. Cas rÃ©els : tir d'un ballon, lancement de projectile, jet d'eau.</p>
            <div class="loi-variables"><p><b>vâ‚€</b> â€” vitesse initiale (m/s)</p><p><b>Î¸</b> â€” angle de lancement (Â°)</p><p><b>g</b> â€” pesanteur (m/sÂ²)</p><p><b>hâ‚€</b> â€” hauteur initiale (m)</p></div>
          </div>
        </div>
        <div class="loi-card" id="loi-circ">
          <div class="loi-header" onclick="toggleLoi(this)"><h4>ğŸ”„ MCU â€” Mouvement Circulaire Uniforme</h4><span class="loi-tag">Ï‰ = cte</span><span class="loi-chevron">â–¼</span></div>
          <div class="loi-body">
            <div class="formula-box">x(t) = RÂ·cos(Ï‰Â·t)   ;   y(t) = RÂ·sin(Ï‰Â·t)</div>
            <div class="formula-box">Ï‰ = v / R   (rad/s)</div>
            <div class="formula-box">a_c = vÂ² / R = Ï‰Â²Â·R  (centripÃ¨te)</div>
            <div class="formula-box">T = 2Ï€ / Ï‰   (pÃ©riode)</div>
            <p class="loi-desc">La norme de la vitesse est constante mais sa direction change. L'accÃ©lÃ©ration centripÃ¨te pointe vers le <strong>centre</strong>. Le vecteur vitesse est <em>tangent</em> Ã  la trajectoire. Cas rÃ©el : satellite en orbite circulaire.</p>
            <div class="loi-variables"><p><b>R</b> â€” rayon (m)</p><p><b>Ï‰</b> â€” vitesse angulaire (rad/s)</p><p><b>a_c</b> â€” accÃ©lÃ©ration centripÃ¨te (m/sÂ²)</p><p><b>T</b> â€” pÃ©riode (s)</p></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RAPPORT -->
    <div class="tab-pane" id="tab-rapport">
      <div class="rapport-section">
        <div class="rapport-info"><p id="txt-rap-info">GÃ©nÃ¨re un rapport de TP complet avec toutes les mesures enregistrÃ©es, les formules utilisÃ©es et une analyse des rÃ©sultats. Disponible aprÃ¨s avoir lancÃ© une simulation.</p></div>
        <div class="rapport-btns">
          <button class="rapport-btn" onclick="exportRapport('csv')"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg><span id="txt-csv">Exporter CSV</span></button>
          <button class="rapport-btn" onclick="exportRapport('pdf')"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span id="txt-pdf">Exporter PDF</span></button>
          <button class="rapport-btn" onclick="takeScreenshot()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg><span id="txt-shot">Capture</span></button>
          <button class="rapport-btn" onclick="clearData()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg><span id="txt-clear">Effacer</span></button>
        </div>
      </div>
    </div>

  </div>
</div>
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIMLAB â€” CINÃ‰MATIQUE  Â·  Objets 3D rÃ©els + dÃ©cors
//  Edmond Atinzoun TCHOKPON Â· UAC BÃ©nin Â· atinzlab.pages.dev
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ I18N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TR={
  fr:{back:'Retour',launch:'Lancer',pause:'Pause',resume:'Reprendre',reset:'Reset',
    tabP:'ParamÃ¨tres',tabM:'Mesures',tabL:'Lois',tabR:'Rapport TP',
    resTitle:'RÃ©sultats',rlx:'Position x',rly:'Position y',rlv:'Vitesse',rla:'AccÃ©lÃ©ration',rlt:'Temps',rlr:'PortÃ©e',
    vlv:'Vecteur vitesse',vla:'Vecteur accÃ©l.',vlt:'Trajectoire',
    mlx:'Position X',mly:'Position Y',mlvx:'Vx',mlvy:'Vy',mlV:'|v|',mlt:'Temps',mld:'Distance',mlec:'Ã‰c. cinÃ©tique',
    lblV0:'Vit. initiale vâ‚€',lblAngle:'Angle Î¸',lblAcc:'AccÃ©l. a',lblG:'GravitÃ© g',lblMass:'Masse m',
    lblH0:'Hauteur hâ‚€',lblR:'Rayon r',lblSpeed:'Vitesse sim.',
    rapInfo:'Rapport de TP disponible aprÃ¨s simulation.',
    csv:'Exporter CSV',pdf:'Imprimer PDF',shot:'Capture',clear:'Effacer',
    tLaunched:'Simulation lancÃ©e !',tPaused:'En pause',tResumed:'Reprise !',
    tReset:'RÃ©initialisÃ©e',tCsv:'CSV exportÃ© !',tShot:'Capture enregistrÃ©e !',
    tNoData:"Lancez d'abord une simulation",tCleared:'DonnÃ©es effacÃ©es',
    tImpact:'Impact ! x = ',simLabel:'Temps',
    info3d:'Orbite Â· Scroll zoom Â· Shift pan'},
  en:{back:'Back',launch:'Launch',pause:'Pause',resume:'Resume',reset:'Reset',
    tabP:'Parameters',tabM:'Measurements',tabL:'Laws',tabR:'Lab Report',
    resTitle:'Results',rlx:'Position x',rly:'Position y',rlv:'Speed',rla:'Acceleration',rlt:'Time',rlr:'Range',
    vlv:'Velocity vector',vla:'Accel. vector',vlt:'Trajectory',
    mlx:'Position X',mly:'Position Y',mlvx:'Vx',mlvy:'Vy',mlV:'|v|',mlt:'Time',mld:'Distance',mlec:'Kinetic energy',
    lblV0:'Initial speed vâ‚€',lblAngle:'Angle Î¸',lblAcc:'Accel. a',lblG:'Gravity g',lblMass:'Mass m',
    lblH0:'Height hâ‚€',lblR:'Radius r',lblSpeed:'Sim. speed',
    rapInfo:'Lab report available after simulation.',
    csv:'Export CSV',pdf:'Print PDF',shot:'Screenshot',clear:'Clear',
    tLaunched:'Simulation launched!',tPaused:'Paused',tResumed:'Resumed!',
    tReset:'Reset',tCsv:'CSV exported!',tShot:'Screenshot saved!',
    tNoData:'Launch a simulation first',tCleared:'Data cleared',
    tImpact:'Impact! x = ',simLabel:'Time',
    info3d:'Orbit Â· Scroll zoom Â· Shift pan'}
};
let lang='fr';
const t=k=>TR[lang][k]||k;
function applyLang(){
  const M={'txt-back':'back','txt-launch':'launch','txt-reset':'reset',
    'tt-p':'tabP','tt-m':'tabM','tt-l':'tabL','tt-r':'tabR',
    'txt-res-title':'resTitle','rl-x':'rlx','rl-y':'rly','rl-v':'rlv','rl-a':'rla','rl-t':'rlt','rl-r':'rlr',
    'vl-v':'vlv','vl-a':'vla','vl-t':'vlt',
    'ml-x':'mlx','ml-y':'mly','ml-vx':'mlvx','ml-vy':'mlvy','ml-v':'mlV','ml-t':'mlt','ml-d':'mld','ml-ec':'mlec',
    'lbl-v0':'lblV0','lbl-angle':'lblAngle','lbl-acc':'lblAcc','lbl-g':'lblG','lbl-mass':'lblMass',
    'lbl-h0':'lblH0','lbl-r':'lblR','lbl-speed':'lblSpeed',
    'txt-rap-info':'rapInfo','txt-csv':'csv','txt-pdf':'pdf','txt-shot':'shot','txt-clear':'clear',
    'sim-label':'simLabel'};
  for(const[id,k]of Object.entries(M)){const e=document.getElementById(id);if(e)e.textContent=t(k);}
  document.getElementById('view-info').textContent=t('info3d');
  updatePauseBtn();
  document.getElementById('lang-btn').textContent=lang==='fr'?'EN':'FR';
}
document.getElementById('lang-btn').addEventListener('click',()=>{lang=lang==='fr'?'en':'fr';applyLang();});

// â”€â”€ SLIDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SD=[
  {id:'sl-v0',dp:'val-v0',unit:' m/s',f:v=>v.toFixed(1)},
  {id:'sl-angle',dp:'val-angle',unit:'Â°',f:v=>v.toFixed(0)},
  {id:'sl-a',dp:'val-a',unit:' m/sÂ²',f:v=>v.toFixed(1)},
  {id:'sl-g',dp:'val-g',unit:' m/sÂ²',f:v=>v.toFixed(2)},
  {id:'sl-mass',dp:'val-mass',unit:' kg',f:v=>v.toFixed(1)},
  {id:'sl-h0',dp:'val-h0',unit:' m',f:v=>v.toFixed(1)},
  {id:'sl-r',dp:'val-r',unit:' m',f:v=>v.toFixed(1)},
  {id:'sl-speed',dp:'val-speed',unit:'Ã—',f:v=>v.toFixed(1)},
];
const gP=()=>({v0:+sl('sl-v0'),angle:+sl('sl-angle'),a:+sl('sl-a'),g:+sl('sl-g'),
  mass:+sl('sl-mass'),h0:+sl('sl-h0'),r:+sl('sl-r'),speed:+sl('sl-speed')});
const sl=id=>document.getElementById(id).value;
SD.forEach(s=>{
  const el=document.getElementById(s.id),dp=document.getElementById(s.dp);
  dp.textContent=s.f(+el.value)+s.unit;
  el.addEventListener('input',()=>{dp.textContent=s.f(+el.value)+s.unit;if(!simRunning){if(cur3D)idleThree();else drawIdle2D();}});
});

// â”€â”€ APP STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentMode='proj',cur3D=false;
let simRunning=false,simPaused=false,animId=null,lastTs=null,simTime=0,maxST=20;
let state={x:0,y:0,vx:0,vy:0,ax:0,ay:0};
let traj2D=[],traj3Dpts=[],recordedData=[];

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab-btn[data-tab]').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn[data-tab]').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');document.getElementById('tab-'+b.dataset.tab).classList.add('active');
    document.getElementById('ctrl-panel').classList.remove('collapsed');
  });
});
let panelC=false;
document.getElementById('tabs-collapse').addEventListener('click',()=>{
  panelC=!panelC;document.getElementById('ctrl-panel').classList.toggle('collapsed',panelC);
  document.getElementById('tabs-collapse').textContent=panelC?'â–²':'â–¼';
  setTimeout(resizeAll,310);
});

// â”€â”€ MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.mode-btn[data-mode]').forEach(b=>{
  b.addEventListener('click',()=>{
    currentMode=b.dataset.mode;
    document.querySelectorAll('.mode-btn[data-mode]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');doReset();updateCards();updateLoisHL();
    if(cur3D)rebuildThreeScene();
  });
});
function updateCards(){
  document.getElementById('card-angle').style.display=currentMode==='proj'?'':'none';
  document.getElementById('card-a').style.display=currentMode==='mrua'?'':'none';
  document.getElementById('card-g').style.display=currentMode==='proj'?'':'none';
  document.getElementById('card-h0').style.display=currentMode==='proj'?'':'none';
  document.getElementById('card-r').style.display=currentMode==='circ'?'':'none';
}
function updateLoisHL(){
  ['mru','mrua','proj','circ'].forEach(k=>document.getElementById('loi-'+k).classList.toggle('open',k===currentMode));
}
updateCards();updateLoisHL();

// â”€â”€ VIEW TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.view-btn[data-view]').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.view-btn[data-view]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');switchView(b.dataset.view==='3d');
  });
});
function switchView(to3d){
  cur3D=to3d;
  const c2=document.getElementById('simCanvas'),c3=document.getElementById('threeCanvas');
  const vi=document.getElementById('view-info'),vl=document.getElementById('vector-legend');
  const mb=document.getElementById('mode-badge'),wrap=document.getElementById('canvas-wrap');
  if(to3d){
    c2.style.display='none';c3.style.display='block';
    wrap.classList.remove('mode2d');vi.style.display='block';vl.style.display='none';
    mb.style.display='block';mb.textContent=modeLabel3D();
    vi.textContent=t('info3d');
    doReset();buildThree();
  } else {
    c2.style.display='block';c3.style.display='none';
    wrap.classList.add('mode2d');vi.style.display='none';vl.style.display='block';mb.style.display='none';
    doReset();
  }
}
function modeLabel3D(){
  const labels={mru:'ğŸš— MRU',mrua:'ğŸ³ MRUA',proj:'âš½ Projectile',circ:'ğŸª Circulaire'};
  return labels[currentMode]||currentMode;
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastT=null;
function toast(msg,type='info'){
  const el=document.getElementById('toast');el.textContent=msg;el.className='show toast-'+type;
  clearTimeout(toastT);toastT=setTimeout(()=>el.className='',2600);
}

// â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnParticles(cx,cy,n,col){
  const layer=document.getElementById('particles-layer');
  for(let i=0;i<n;i++){
    const p=document.createElement('div'),a=Math.random()*Math.PI*2,d=25+Math.random()*80,s=3+Math.random()*6;
    p.className='particle';
    p.style.cssText=`left:${cx}px;top:${cy}px;width:${s}px;height:${s}px;background:${col};--dx:${Math.cos(a)*d}px;--dy:${Math.sin(a)*d}px;box-shadow:0 0 6px ${col}`;
    layer.appendChild(p);setTimeout(()=>p.remove(),1100);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  2D CANVAS ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cv=document.getElementById('simCanvas'),ctx=cv.getContext('2d');
let SC=30;
function resize2D(){const w=document.getElementById('canvas-wrap');cv.width=w.clientWidth;cv.height=w.clientHeight;}
function computeSC(){
  // SC = pixels per meter. In follow-cam mode we just need a comfortable zoom.
  const p=gP(),W=cv.width,H=cv.height;
  if(currentMode==='mru'||currentMode==='mrua'){
    // show ~15s worth at a time on screen
    const dist15=Math.abs(p.v0)*15+.5*Math.abs(p.a)*225;
    SC=Math.max(5,Math.min(60,(W*.6)/(dist15||30)));
    maxST=30;
  } else if(currentMode==='proj'){
    const th=p.angle*Math.PI/180,vy0=p.v0*Math.sin(th);
    maxST=p.g>0?(vy0+Math.sqrt(Math.max(0,vy0*vy0+2*p.g*p.h0)))/p.g:5;
    if(!isFinite(maxST)||maxST<=0)maxST=10;
    const maxX=p.v0*Math.cos(th)*maxST,maxY=p.h0+vy0*vy0/(2*(p.g||.001));
    SC=Math.max(5,Math.min(80,Math.min((W*.6)/(maxX||10),(H*.55)/(maxY+2||10))));
  } else {
    maxST=(2*Math.PI*p.r/p.v0)*3;
    SC=Math.max(8,Math.min(cv.width,cv.height)/(2*(p.r+2))*.72);
  }
}
// Camera offset for 2D: follows object so it stays visible
let cam2D={ox:0,oy:0}; // world-space origin currently displayed at screen anchor
function updateCam2D(){
  if(!simRunning){cam2D={ox:0,oy:0};return;}
  if(currentMode==='circ'){
    // center stays at world (0,0) for circular
    cam2D={ox:0,oy:0};
  } else {
    // keep object at 30% from left, 60% from bottom
    cam2D={ox:state.x - (cv.width*.30)/SC, oy:state.y - (cv.height*.40)/SC};
  }
}
const w2c=(xM,yM)=>{
  if(currentMode==='circ') return{x:cv.width/2+xM*SC,y:cv.height/2-yM*SC};
  return{x:(xM-cam2D.ox)*SC, y:cv.height-(yM-cam2D.oy)*SC};
};
function drawArrow2D(x1,y1,x2,y2,col,lw=2){
  const dx=x2-x1,dy=y2-y1,len=Math.sqrt(dx*dx+dy*dy);if(len<2)return;
  const ux=dx/len,uy=dy/len,hl=Math.min(14,len*.35);
  ctx.beginPath();ctx.strokeStyle=col;ctx.lineWidth=lw;ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();
  ctx.beginPath();ctx.fillStyle=col;
  ctx.moveTo(x2,y2);ctx.lineTo(x2-hl*(ux-uy*.4),y2-hl*(uy+ux*.4));ctx.lineTo(x2-hl*(ux+uy*.4),y2-hl*(uy-ux*.4));
  ctx.closePath();ctx.fill();
}
function drawAxes2D(){
  const W=cv.width,H=cv.height;
  ctx.strokeStyle='rgba(42,58,92,.8)';ctx.lineWidth=1;
  if(currentMode==='circ'){
    ctx.beginPath();ctx.moveTo(W/2,0);ctx.lineTo(W/2,H);ctx.moveTo(0,H/2);ctx.lineTo(W,H/2);ctx.stroke();
    ctx.fillStyle='#4a5568';ctx.font='11px JetBrains Mono';ctx.fillText('x',W-20,H/2-6);ctx.fillText('y',W/2+8,16);return;
  }
  // x-axis: at y=0 in world
  const yAxisScreen=H-(-cam2D.oy)*SC; // screen y where world y=0
  const xAxisScreen=(-cam2D.ox)*SC;   // screen x where world x=0
  const axY=Math.max(20,Math.min(H-20,yAxisScreen));
  const axX=Math.max(20,Math.min(W-20,xAxisScreen));
  // horizontal axis
  ctx.beginPath();ctx.moveTo(0,axY);ctx.lineTo(W,axY);ctx.stroke();
  // vertical axis (only if x=0 visible)
  if(axX>0&&axX<W){ctx.beginPath();ctx.moveTo(axX,0);ctx.lineTo(axX,H);ctx.stroke();}
  // ticks x
  ctx.fillStyle='#4a5568';ctx.font='10px JetBrains Mono';ctx.textAlign='center';
  const x0w=cam2D.ox, x1w=cam2D.ox+W/SC;
  for(let i=Math.ceil(x0w);i<=Math.floor(x1w)+1;i++){
    const px=(i-cam2D.ox)*SC;if(px<0||px>W)continue;
    ctx.beginPath();ctx.moveTo(px,axY-3);ctx.lineTo(px,axY+3);ctx.stroke();
    if(i%5===0)ctx.fillText(i,px,axY+14);
  }
  // ticks y
  const y0w=cam2D.oy, y1w=cam2D.oy+H/SC;
  ctx.textAlign='right';
  for(let i=Math.ceil(y0w);i<=Math.floor(y1w)+1;i++){
    const py=H-(i-cam2D.oy)*SC;if(py<0||py>H)continue;
    ctx.beginPath();ctx.moveTo(axX-3,py);ctx.lineTo(axX+3,py);ctx.stroke();
    if(i%5===0)ctx.fillText(i,axX-6,py+4);
  }
  ctx.fillStyle='#8898b0';ctx.font='12px Outfit';ctx.textAlign='center';
  ctx.fillText('x (m)',W/2,H-6);
  ctx.save();ctx.translate(14,H/2);ctx.rotate(-Math.PI/2);ctx.fillText('y (m)',0,0);ctx.restore();
}
function drawObj2D(xM,yM,vx,vy,ax,ay){
  const{x,y}=w2c(xM,yM);
  const g=ctx.createRadialGradient(x,y,0,x,y,22);g.addColorStop(0,'rgba(0,229,255,.28)');g.addColorStop(1,'rgba(0,229,255,0)');
  ctx.beginPath();ctx.arc(x,y,22,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
  ctx.beginPath();ctx.arc(x,y,10,0,Math.PI*2);ctx.fillStyle='#00e5ff';ctx.shadowBlur=14;ctx.shadowColor='#00e5ff';ctx.fill();ctx.shadowBlur=0;
  ctx.strokeStyle='rgba(255,255,255,.35)';ctx.lineWidth=1.5;ctx.stroke();
  const vM=Math.sqrt(vx*vx+vy*vy);if(vM>.01){const ep=w2c(xM+vx*5/SC,yM+vy*5/SC);drawArrow2D(x,y,ep.x,ep.y,'#00e5ff',2);}
  const aM=Math.sqrt(ax*ax+ay*ay);if(aM>.01){const ep=w2c(xM+ax*5/SC,yM+ay*5/SC);drawArrow2D(x,y,ep.x,ep.y,'#ff8c00',2);}
}
function drawTraj2D(){
  if(traj2D.length<2)return;
  ctx.beginPath();ctx.strokeStyle='rgba(192,132,252,.55)';ctx.lineWidth=1.5;ctx.setLineDash([4,4]);
  const p0=w2c(traj2D[0].x,traj2D[0].y);ctx.moveTo(p0.x,p0.y);
  traj2D.forEach(p=>{const c=w2c(p.x,p.y);ctx.lineTo(c.x,c.y);});
  ctx.stroke();ctx.setLineDash([]);
}
function drawIdle2D(){
  cam2D={ox:0,oy:0};
  ctx.clearRect(0,0,cv.width,cv.height);computeSC();drawAxes2D();
  const p=gP();
  if(currentMode==='circ'){
    const{x:cx,y:cy}=w2c(0,0);
    ctx.beginPath();ctx.arc(cx,cy,p.r*SC,0,Math.PI*2);ctx.strokeStyle='rgba(192,132,252,.25)';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.stroke();ctx.setLineDash([]);
    const om=p.v0/p.r;drawObj2D(p.r,0,0,p.v0,-om*om*p.r,0);
  } else if(currentMode==='proj'){
    const th=p.angle*Math.PI/180,vx0=p.v0*Math.cos(th),vy0=p.v0*Math.sin(th);
    ctx.beginPath();ctx.strokeStyle='rgba(192,132,252,.2)';ctx.lineWidth=1;ctx.setLineDash([4,4]);
    for(let ti=0;ti<=maxST;ti+=0.05){const px=vx0*ti,py=p.h0+vy0*ti-.5*p.g*ti*ti;if(py<-2)break;const c=w2c(px,py);ti===0?ctx.moveTo(c.x,c.y):ctx.lineTo(c.x,c.y);}
    ctx.stroke();ctx.setLineDash([]);drawObj2D(0,p.h0,vx0,vy0,0,-p.g);
  } else {drawObj2D(0,0,p.v0,0,currentMode==='mrua'?p.a:0,0);}
}
let pinchSC0=1,pinchD0=0;
cv.addEventListener('touchstart',e=>{if(e.touches.length===2){pinchD0=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);pinchSC0=SC;e.preventDefault();}},{passive:false});
cv.addEventListener('touchmove',e=>{if(e.touches.length===2){const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);SC=Math.max(4,Math.min(120,pinchSC0*d/pinchD0));if(!simRunning)drawIdle2D();e.preventDefault();}},{passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THREE.JS ENGINE â€” OBJETS RÃ‰ELS + DÃ‰CORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let TR3={renderer:null,scene:null,camera:null,obj:null,velArrow:null,accArrow:null,trajLine:null,rafId:null};
let orbit={th:Math.PI/6,phi:.55,r:32,panX:0,panZ:0,drag:false,btn:-1,sx:0,sy:0,pd:0};

function buildThree(){
  const c3=document.getElementById('threeCanvas'),wrap=document.getElementById('canvas-wrap');
  if(TR3.renderer){cancelAnimationFrame(TR3.rafId);TR3.renderer.dispose();}
  const W=wrap.clientWidth,H=wrap.clientHeight;
  const renderer=new THREE.WebGLRenderer({canvas:c3,antialias:true});
  renderer.setSize(W,H);renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;
  const scene=new THREE.Scene();
  const camera=new THREE.PerspectiveCamera(55,W/H,.1,600);
  TR3={renderer,scene,camera,obj:null,velArrow:null,accArrow:null,trajLine:null,rafId:null};
  updateCam();
  orbit.panX=0;orbit.panZ=0;
  if(currentMode==='circ'){const p=gP();orbit.r=Math.max(p.r*2.5,14);}
  else if(currentMode==='proj'){orbit.r=22;}
  else{orbit.r=18;}
  orbitTarget.set(0,0,0);orbitTargetSmooth.set(0,0,0);
  setupOrbit(c3);
  rebuildThreeScene();
  startRender3D();
}

function rebuildThreeScene(){
  if(!TR3.scene)return;
  const scene=TR3.scene;
  // clear scene objects (keep renderer/camera)
  while(scene.children.length>0)scene.remove(scene.children[0]);
  const p=gP();

  // â”€â”€ SHARED LIGHTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  scene.add(new THREE.AmbientLight(0xffffff,.5));
  const sun=new THREE.DirectionalLight(0xffffff,1.2);
  sun.position.set(20,40,20);sun.castShadow=true;
  sun.shadow.mapSize.set(2048,2048);sun.shadow.camera.far=200;sun.shadow.camera.near=1;
  sun.shadow.camera.left=-60;sun.shadow.camera.right=60;sun.shadow.camera.top=60;sun.shadow.camera.bottom=-60;
  scene.add(sun);

  if(currentMode==='mru'||currentMode==='mrua'){
    buildSceneRoad(scene,p);
  } else if(currentMode==='proj'){
    buildSceneField(scene,p);
  } else {
    buildSceneSpace(scene,p);
  }

  // â”€â”€ TRAJECTORY LINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const tg=new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,.01,0)]);
  TR3.trajLine=new THREE.Line(tg,new THREE.LineBasicMaterial({color:0xc084fc,transparent:true,opacity:.8}));
  scene.add(TR3.trajLine);
  traj3Dpts=[];

  idleThree();
}

// â”€â”€ SCENE: ROAD (MRU / MRUA) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSceneRoad(scene,p){
  // Sky gradient background
  scene.background=new THREE.Color(0x87ceeb);
  scene.fog=new THREE.Fog(0x87ceeb,60,200);

  // Ground asphalt
  const asphaltMat=new THREE.MeshLambertMaterial({color:0x2d2d2d});
  const road=new THREE.Mesh(new THREE.PlaneGeometry(200,12),asphaltMat);
  road.rotation.x=-Math.PI/2;road.receiveShadow=true;scene.add(road);

  // Road markings (dashed center line)
  const dashMat=new THREE.MeshLambertMaterial({color:0xffffff});
  for(let i=-90;i<100;i+=8){
    const dash=new THREE.Mesh(new THREE.PlaneGeometry(4,.2),dashMat);
    dash.rotation.x=-Math.PI/2;dash.position.set(i,.01,0);scene.add(dash);
  }
  // Side lines
  const sideMat=new THREE.MeshLambertMaterial({color:0xffff00});
  [-5.5,5.5].forEach(z=>{
    const line=new THREE.Mesh(new THREE.PlaneGeometry(200,.15),sideMat);
    line.rotation.x=-Math.PI/2;line.position.set(0,.01,z);scene.add(line);
  });

  // Grass sides
  const grassMat=new THREE.MeshLambertMaterial({color:0x4a8c3f});
  [-8,8].forEach(z=>{
    const g=new THREE.Mesh(new THREE.PlaneGeometry(200,8),grassMat);
    g.rotation.x=-Math.PI/2;g.position.set(0,-.01,z);g.receiveShadow=true;scene.add(g);
  });

  // Trees along road
  for(let i=-80;i<100;i+=15){
    [-9,9].forEach(z=>{
      const trunk=new THREE.Mesh(new THREE.CylinderGeometry(.2,.25,1.5,8),new THREE.MeshLambertMaterial({color:0x5c3a1e}));
      trunk.position.set(i,.75,z);trunk.castShadow=true;scene.add(trunk);
      const crown=new THREE.Mesh(new THREE.SphereGeometry(1.2,8,8),new THREE.MeshLambertMaterial({color:0x2d6a27}));
      crown.position.set(i,2,z);crown.castShadow=true;scene.add(crown);
    });
  }

  // Car object
  TR3.obj=buildCar(scene);
  TR3.obj.position.set(0,.45,0);

  buildArrows3D(scene);
}

function buildCar(scene){
  const car=new THREE.Group();
  // Body
  const body=new THREE.Mesh(new THREE.BoxGeometry(3.2,1,1.8),new THREE.MeshPhongMaterial({color:0x1a73e8,shininess:120}));
  body.position.y=.5;body.castShadow=true;car.add(body);
  // Cabin
  const cabin=new THREE.Mesh(new THREE.BoxGeometry(1.8,.7,1.6),new THREE.MeshPhongMaterial({color:0x0d47a1,shininess:60}));
  cabin.position.set(-.1,1.15,0);cabin.castShadow=true;car.add(cabin);
  // Windows
  const winMat=new THREE.MeshPhongMaterial({color:0x89cff0,transparent:true,opacity:.7,shininess:200});
  const winF=new THREE.Mesh(new THREE.PlaneGeometry(1.5,.55),winMat);
  winF.position.set(.7,1.15,.82);car.add(winF);
  const winB=new THREE.Mesh(new THREE.PlaneGeometry(1.5,.55),winMat);
  winB.position.set(-.5,1.15,-.83);winB.rotation.y=Math.PI;car.add(winB);
  // Wheels
  const wMat=new THREE.MeshPhongMaterial({color:0x111111,shininess:30});
  const wRim=new THREE.MeshPhongMaterial({color:0xcccccc,shininess:100});
  [[1.1,.3,.95],[1.1,.3,-.95],[-1.1,.3,.95],[-1.1,.3,-.95]].forEach(([x,y,z])=>{
    const w=new THREE.Mesh(new THREE.CylinderGeometry(.35,.35,.25,16),wMat);
    w.rotation.z=Math.PI/2;w.position.set(x,y,z);w.castShadow=true;car.add(w);
    const rim=new THREE.Mesh(new THREE.CylinderGeometry(.18,.18,.27,8),wRim);
    rim.rotation.z=Math.PI/2;rim.position.set(x,y,z);car.add(rim);
  });
  // Headlights
  const hlMat=new THREE.MeshPhongMaterial({color:0xffffaa,emissive:0xffff44,emissiveIntensity:.5});
  [[1.6,.5,.6],[1.6,.5,-.6]].forEach(([x,y,z])=>{
    const hl=new THREE.Mesh(new THREE.SphereGeometry(.12,8,8),hlMat);hl.position.set(x,y,z);car.add(hl);
  });
  // Point light on car
  const pl=new THREE.PointLight(0xffffaa,.6,10);pl.position.set(2,.8,0);car.add(pl);
  scene.add(car);
  return car;
}

// â”€â”€ SCENE: FOOTBALL FIELD (PROJECTILE) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSceneField(scene,p){
  scene.background=new THREE.Color(0x5b8dd9);
  scene.fog=new THREE.Fog(0x87ceeb,80,250);

  // Sky with clouds
  const cloudMat=new THREE.MeshLambertMaterial({color:0xffffff,transparent:true,opacity:.9});
  for(let i=0;i<8;i++){
    const cg=new THREE.Group();
    [0,1.2,-1].forEach((dx,j)=>{
      const c=new THREE.Mesh(new THREE.SphereGeometry(1.5+j*.3,8,6),cloudMat);
      c.position.set(dx,0,0);cg.add(c);
    });
    cg.position.set(-40+i*12,20+Math.random()*6,Math.random()*10-5);cg.scale.setScalar(.8+Math.random()*.5);
    scene.add(cg);
  }

  // Ground (grass with texture feel)
  const grassMat=new THREE.MeshLambertMaterial({color:0x3a7d44});
  const ground=new THREE.Mesh(new THREE.PlaneGeometry(200,60),grassMat);
  ground.rotation.x=-Math.PI/2;ground.receiveShadow=true;scene.add(ground);
  // Field lines
  const lineMat=new THREE.MeshLambertMaterial({color:0x5a9e5a});
  for(let i=0;i<12;i++){
    const strip=new THREE.Mesh(new THREE.PlaneGeometry(16.6,60),lineMat);
    strip.rotation.x=-Math.PI/2;strip.position.set(i*16.6-83,.005,0);if(i%2===0)scene.add(strip);
  }
  // White lines
  const wl=new THREE.MeshLambertMaterial({color:0xffffff});
  [-50,0,50].forEach(x=>{
    const line=new THREE.Mesh(new THREE.PlaneGeometry(.2,60),wl);
    line.rotation.x=-Math.PI/2;line.position.set(x,.01,0);scene.add(line);
  });

  // Goalposts at x=0 and far end
  buildGoalpost(scene,80,0,0xffffff);

  // Football (soccer ball) object
  TR3.obj=buildFootball(scene);
  TR3.obj.position.set(0,.4,0);

  buildArrows3D(scene);
}

function buildFootball(scene){
  const ball=new THREE.Group();
  // Main sphere
  const sphere=new THREE.Mesh(new THREE.SphereGeometry(.4,32,32),
    new THREE.MeshPhongMaterial({color:0xffffff,shininess:80}));
  ball.add(sphere);
  // Black pentagons (approximated with circle patches)
  const patchMat=new THREE.MeshPhongMaterial({color:0x111111});
  const patchDirs=[
    new THREE.Vector3(0,1,0),new THREE.Vector3(0,-1,0),
    new THREE.Vector3(1,0,0),new THREE.Vector3(-1,0,0),
    new THREE.Vector3(0,.5,.86),new THREE.Vector3(0,.5,-.86),
  ];
  patchDirs.forEach(dir=>{
    const patch=new THREE.Mesh(new THREE.CircleGeometry(.16,5),patchMat);
    patch.position.copy(dir.normalize().multiplyScalar(.41));
    patch.lookAt(patch.position.clone().multiplyScalar(2));
    ball.add(patch);
  });
  ball.castShadow=true;
  scene.add(ball);
  return ball;
}

function buildGoalpost(scene,x,z,col){
  const mat=new THREE.MeshPhongMaterial({color:col,shininess:60});
  const r=.12,h=5,w=7.32;
  // posts
  [-w/2,w/2].forEach(dz=>{
    const post=new THREE.Mesh(new THREE.CylinderGeometry(r,r,h,8),mat);
    post.position.set(x,h/2,z+dz);post.castShadow=true;scene.add(post);
  });
  // crossbar
  const bar=new THREE.Mesh(new THREE.CylinderGeometry(r,r,w,8),mat);
  bar.rotation.z=Math.PI/2;bar.position.set(x,h,z);bar.castShadow=true;scene.add(bar);
}

// â”€â”€ SCENE: SPACE (MCU) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSceneSpace(scene,p){
  scene.background=new THREE.Color(0x020510);
  scene.fog=null;

  // Stars
  const starGeo=new THREE.BufferGeometry();
  const starPos=[];for(let i=0;i<2000;i++){starPos.push((Math.random()-.5)*400,(Math.random()-.5)*400,(Math.random()-.5)*400);}
  starGeo.setAttribute('position',new THREE.Float32BufferAttribute(starPos,3));
  scene.add(new THREE.Points(starGeo,new THREE.PointsMaterial({color:0xffffff,size:.5})));

  // Milky way glow
  const mwGeo=new THREE.TorusGeometry(80,20,8,64);
  const mwMat=new THREE.MeshBasicMaterial({color:0x334466,transparent:true,opacity:.08,side:THREE.DoubleSide});
  scene.add(new THREE.Mesh(mwGeo,mwMat));

  // Central planet (sun-like)
  const sunGeo=new THREE.SphereGeometry(3.5,32,32);
  const sunMat=new THREE.MeshBasicMaterial({color:0xff8822});
  const sunMesh=new THREE.Mesh(sunGeo,sunMat);
  scene.add(sunMesh);
  // Sun glow rings
  [5,7,9].forEach((r,i)=>{
    const ring=new THREE.Mesh(new THREE.TorusGeometry(r,.08+i*.04,8,64),
      new THREE.MeshBasicMaterial({color:0xff6600,transparent:true,opacity:.15-i*.04}));
    ring.rotation.x=Math.PI/2;scene.add(ring);
  });
  const sunLight=new THREE.PointLight(0xffaa44,2,120);scene.add(sunLight);

  // Orbit circle
  const orbitRing=new THREE.Mesh(new THREE.TorusGeometry(p.r,.04,8,128),
    new THREE.MeshBasicMaterial({color:0x4466aa,transparent:true,opacity:.35}));
  orbitRing.rotation.x=Math.PI/2;scene.add(orbitRing);

  // Satellite / planet object
  TR3.obj=buildSatellite(scene);
  TR3.obj.position.set(p.r,0,0);

  buildArrows3D(scene);
}

function buildSatellite(scene){
  const sat=new THREE.Group();
  // Planet body
  const body=new THREE.Mesh(new THREE.SphereGeometry(.7,32,32),
    new THREE.MeshPhongMaterial({color:0x4499cc,emissive:0x001122,shininess:60}));
  // surface detail
  const detail=new THREE.Mesh(new THREE.SphereGeometry(.72,16,16),
    new THREE.MeshBasicMaterial({color:0x2255aa,wireframe:true,transparent:true,opacity:.08}));
  sat.add(body,detail);
  // rings (like Saturn)
  const ring=new THREE.Mesh(new THREE.TorusGeometry(1.1,.2,4,32),
    new THREE.MeshBasicMaterial({color:0xccaa55,transparent:true,opacity:.6,side:THREE.DoubleSide}));
  ring.rotation.x=Math.PI/3;sat.add(ring);
  // Atmosphere glow
  const atm=new THREE.Mesh(new THREE.SphereGeometry(.82,16,16),
    new THREE.MeshBasicMaterial({color:0x44aaff,transparent:true,opacity:.12,depthWrite:false}));
  sat.add(atm);
  sat.castShadow=true;
  scene.add(sat);
  return sat;
}

// â”€â”€ SHARED ARROW HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildArrows3D(scene){
  TR3.velArrow=new THREE.ArrowHelper(new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,0),2,0x00e5ff,.4,.15);
  TR3.accArrow=new THREE.ArrowHelper(new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,0),1.5,0xff8c00,.35,.12);
  scene.add(TR3.velArrow,TR3.accArrow);
}

function updateArrows3D(){
  if(!TR3.obj||!TR3.velArrow)return;
  const{vx,vy,ax,ay}=state;
  const pos=TR3.obj.position.clone();
  const vM=Math.sqrt(vx*vx+vy*vy);
  if(vM>.01){
    TR3.velArrow.visible=true;TR3.velArrow.position.copy(pos);
    TR3.velArrow.setDirection(new THREE.Vector3(vx,vy,0).normalize());
    TR3.velArrow.setLength(Math.min(8,vM*.3),.4,.15);
  } else TR3.velArrow.visible=false;
  const aM=Math.sqrt((ax||0)**2+(ay||0)**2);
  if(aM>.01){
    TR3.accArrow.visible=true;TR3.accArrow.position.copy(pos);
    TR3.accArrow.setDirection(new THREE.Vector3(ax||0,ay||0,0).normalize());
    TR3.accArrow.setLength(Math.min(6,aM*.4),.35,.12);
  } else TR3.accArrow.visible=false;
}

function idleThree(){
  if(!TR3.obj)return;
  const p=gP();
  if(currentMode==='circ'){TR3.obj.position.set(p.r,0,0);}
  else if(currentMode==='proj'){TR3.obj.position.set(0,p.h0,0);}
  else{TR3.obj.position.set(0,currentMode==='mru'?.45:.45,0);}
  if(TR3.velArrow){TR3.velArrow.visible=false;}
  if(TR3.accArrow){TR3.accArrow.visible=false;}
}

// â”€â”€ ORBIT CONTROL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// orbitTarget = world point the orbit pivots around (follows object)
let orbitTarget=new THREE.Vector3(0,0,0);
let orbitTargetSmooth=new THREE.Vector3(0,0,0);

function updateCam(){
  if(!TR3.camera)return;
  // smooth follow
  orbitTargetSmooth.lerp(orbitTarget,.08);
  const x=orbit.r*Math.sin(orbit.phi)*Math.sin(orbit.th)+orbitTargetSmooth.x+orbit.panX;
  const y=orbit.r*Math.cos(orbit.phi)+orbitTargetSmooth.y;
  const z=orbit.r*Math.sin(orbit.phi)*Math.cos(orbit.th)+orbitTargetSmooth.z+orbit.panZ;
  TR3.camera.position.set(x,y,z);
  TR3.camera.lookAt(orbitTargetSmooth.x+orbit.panX, orbitTargetSmooth.y, orbitTargetSmooth.z+orbit.panZ);
}

function followObject3D(){
  if(!TR3.obj)return;
  const pos=TR3.obj.position;
  if(currentMode==='circ'){
    // for circular: look at center (0,0,0), don't follow
    orbitTarget.set(0,0,0);
    // auto-set radius to see the whole orbit
    const p=gP();
    if(!orbit.drag) orbit.r=Math.max(p.r*2.5,12);
  } else {
    // follow object: target = object position with slight look-ahead
    orbitTarget.set(pos.x, Math.max(0,pos.y), pos.z);
  }
  updateCam();
}
function setupOrbit(canvas){
  canvas.addEventListener('mousedown',e=>{orbit.drag=true;orbit.btn=e.button;orbit.sx=e.clientX;orbit.sy=e.clientY;});
  window.addEventListener('mousemove',e=>{
    if(!orbit.drag)return;
    const dx=e.clientX-orbit.sx,dy=e.clientY-orbit.sy;orbit.sx=e.clientX;orbit.sy=e.clientY;
    if(orbit.btn===0&&!e.shiftKey){orbit.th-=dx*.006;orbit.phi=Math.max(.05,Math.min(Math.PI/2-.02,orbit.phi+dy*.006));}
    else{orbit.panX-=dx*.03;orbit.panZ+=dy*.03;}
    updateCam();
  });
  window.addEventListener('mouseup',()=>orbit.drag=false);
  canvas.addEventListener('wheel',e=>{orbit.r=Math.max(5,Math.min(150,orbit.r+e.deltaY*.06));updateCam();e.preventDefault();},{passive:false});
  canvas.addEventListener('touchstart',e=>{
    if(e.touches.length===1){orbit.drag=true;orbit.btn=0;orbit.sx=e.touches[0].clientX;orbit.sy=e.touches[0].clientY;}
    else if(e.touches.length===2)orbit.pd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    e.preventDefault();
  },{passive:false});
  canvas.addEventListener('touchmove',e=>{
    if(e.touches.length===1&&orbit.drag){
      const dx=e.touches[0].clientX-orbit.sx,dy=e.touches[0].clientY-orbit.sy;
      orbit.sx=e.touches[0].clientX;orbit.sy=e.touches[0].clientY;
      orbit.th-=dx*.007;orbit.phi=Math.max(.05,Math.min(Math.PI/2-.02,orbit.phi+dy*.007));updateCam();
    } else if(e.touches.length===2){
      const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      orbit.r=Math.max(5,Math.min(150,orbit.r*(orbit.pd/d)));orbit.pd=d;updateCam();
    }
    e.preventDefault();
  },{passive:false});
  canvas.addEventListener('touchend',()=>orbit.drag=false);
}

function startRender3D(){
  if(TR3.rafId)cancelAnimationFrame(TR3.rafId);
  const render=()=>{TR3.rafId=requestAnimationFrame(render);if(TR3.renderer&&TR3.scene&&TR3.camera)TR3.renderer.render(TR3.scene,TR3.camera);};
  render();
}

function updateThree3D(){
  if(!TR3.obj)return;
  const{x,y,vx,vy}=state;
  // position object
  if(currentMode==='mru'||currentMode==='mrua'){
    TR3.obj.position.set(x,.45,0);
    // rotate wheels based on speed
    const w=TR3.obj.children.filter((_,i)=>i>2&&i<7);
    w.forEach(wh=>{if(wh.geometry&&wh.geometry.type==='CylinderGeometry')wh.rotation.x+=vx*.05;});
    // car faces direction
    if(Math.abs(vx)>.1)TR3.obj.rotation.y=vx>0?0:Math.PI;
  } else if(currentMode==='proj'){
    TR3.obj.position.set(x,Math.max(.4,y),0);
    // ball spins
    TR3.obj.rotation.x+=.08;TR3.obj.rotation.z+=.04;
    // bounce dust on impact
  } else if(currentMode==='circ'){
    TR3.obj.position.set(x,y,0);
    // satellite rotates
    TR3.obj.rotation.y+=.02;TR3.obj.rotation.z+=.005;
  }
  // trajectory
  traj3Dpts.push(TR3.obj.position.clone());
  if(traj3Dpts.length>3000)traj3Dpts.shift();
  if(traj3Dpts.length>=2)TR3.trajLine.geometry.setFromPoints(traj3Dpts);
  updateArrows3D();
  followObject3D();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHYSICS ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initState(){
  const p=gP();simTime=0;traj2D=[];traj3Dpts=[];
  if(currentMode==='mru'){state={x:0,y:0,vx:p.v0,vy:0,ax:0,ay:0};maxST=30;}
  else if(currentMode==='mrua'){state={x:0,y:0,vx:p.v0,vy:0,ax:p.a,ay:0};maxST=30;}
  else if(currentMode==='proj'){
    const th=p.angle*Math.PI/180,vy0=p.v0*Math.sin(th);
    state={x:0,y:p.h0,vx:p.v0*Math.cos(th),vy:vy0,ax:0,ay:-p.g};
    maxST=p.g>0?(vy0+Math.sqrt(Math.max(0,vy0*vy0+2*p.g*p.h0)))/p.g:5;
    if(!isFinite(maxST)||maxST<=0)maxST=10;
  } else {
    const om=p.v0/p.r;
    state={theta:0,omega:om,r:p.r,x:p.r,y:0,vx:0,vy:p.v0,ax:-om*om*p.r,ay:0};
    maxST=(2*Math.PI/om)*3;
  }
  if(!cur3D)computeSC();
}

function stepPhysics(dt){
  const p=gP();dt*=p.speed;
  if(currentMode==='circ'){
    state.theta+=state.omega*dt;
    state.x=state.r*Math.cos(state.theta);state.y=state.r*Math.sin(state.theta);
    state.vx=-state.r*state.omega*Math.sin(state.theta);state.vy=state.r*state.omega*Math.cos(state.theta);
    state.ax=-state.omega*state.omega*state.x;state.ay=-state.omega*state.omega*state.y;
  } else {
    if(currentMode==='proj'){state.ay=-p.g;state.ax=0;}
    state.vx+=state.ax*dt;state.vy+=state.ay*dt;state.x+=state.vx*dt;state.y+=state.vy*dt;
  }
  simTime+=dt/p.speed;
  traj2D.push({x:state.x,y:state.y});if(traj2D.length>3000)traj2D.shift();
  // end
  if(currentMode==='proj'&&state.y<-.1&&simTime>.1){
    if(!cur3D){const cp=w2c(state.x,0);spawnParticles(cp.x,cp.y,20,'#00ff88');}
    else spawnParticles(document.getElementById('canvas-wrap').clientWidth*.4,document.getElementById('canvas-wrap').clientHeight*.6,20,'#00ff88');
    toast(t('tImpact')+state.x.toFixed(2)+' m','success');endSim();return;
  }
  if(currentMode!=='circ'&&simTime>maxST+1){endSim();return;}
}

function updateUI(){
  const vM=Math.sqrt(state.vx**2+state.vy**2),aM=Math.sqrt((state.ax||0)**2+(state.ay||0)**2);
  const p=gP();
  if(!cur3D){updateCam2D();ctx.clearRect(0,0,cv.width,cv.height);drawAxes2D();drawTraj2D();drawObj2D(state.x,state.y,state.vx,state.vy,state.ax||0,state.ay||0);}
  else updateThree3D();
  document.getElementById('res-x').textContent=state.x.toFixed(2)+' m';
  document.getElementById('res-y').textContent=state.y.toFixed(2)+' m';
  document.getElementById('res-v').textContent=vM.toFixed(2)+' m/s';
  document.getElementById('res-a').textContent=aM.toFixed(2)+' m/sÂ²';
  document.getElementById('res-t').textContent=simTime.toFixed(2)+' s';
  if(currentMode==='proj'){
    const th=p.angle*Math.PI/180;
    document.getElementById('res-r').textContent=(p.v0**2*Math.sin(2*th)/Math.max(p.g,.001)).toFixed(2)+' m';
    document.getElementById('res-row-r').style.display='';
  } else document.getElementById('res-row-r').style.display='none';
  document.getElementById('mv-x').textContent=state.x.toFixed(2);
  document.getElementById('mv-y').textContent=state.y.toFixed(2);
  document.getElementById('mv-vx').textContent=state.vx.toFixed(2);
  document.getElementById('mv-vy').textContent=state.vy.toFixed(2);
  document.getElementById('mv-v').textContent=vM.toFixed(2);
  document.getElementById('mv-t').textContent=simTime.toFixed(2);
  document.getElementById('mv-d').textContent=Math.sqrt(state.x**2+state.y**2).toFixed(2);
  document.getElementById('mv-ec').textContent=(0.5*p.mass*vM**2).toFixed(2);
  document.getElementById('sim-time').textContent=simTime.toFixed(2)+' s';
  document.getElementById('timeline-fill').style.width=Math.min(100,simTime/maxST*100)+'%';
  if(Math.floor(simTime*10)>recordedData.length)
    recordedData.push({t:simTime.toFixed(2),x:state.x.toFixed(3),y:state.y.toFixed(3),vx:state.vx.toFixed(3),vy:state.vy.toFixed(3),v:vM.toFixed(3)});
}

// â”€â”€ LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loop(ts){
  if(!simRunning||simPaused)return;
  if(!lastTs)lastTs=ts;
  const dt=Math.min((ts-lastTs)/1000,.05);lastTs=ts;
  stepPhysics(dt);updateUI();animId=requestAnimationFrame(loop);
}
function endSim(){
  simRunning=false;simPaused=false;if(animId){cancelAnimationFrame(animId);animId=null;}
  lastTs=null;updatePauseBtn();document.getElementById('results-panel').classList.add('visible');
}
function doReset(){
  endSim();simTime=0;traj2D=[];traj3Dpts=[];recordedData=[];
  document.getElementById('results-panel').classList.remove('visible');
  document.getElementById('timeline-fill').style.width='0%';
  document.getElementById('sim-time').textContent='0.00 s';
  if(!cur3D){resize2D();drawIdle2D();}
  else if(TR3.obj){orbit.panX=0;orbit.panZ=0;orbitTarget.set(0,0,0);orbitTargetSmooth.set(0,0,0);idleThree();}
}
function updatePauseBtn(){
  const btn=document.getElementById('btn-pause'),sp=document.getElementById('txt-pause');
  if(simPaused){btn.classList.add('paused');sp.textContent=t('resume');}
  else{btn.classList.remove('paused');sp.textContent=t('pause');}
}

// â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-launch').addEventListener('click',()=>{
  if(simPaused){simPaused=false;simRunning=true;lastTs=null;updatePauseBtn();animId=requestAnimationFrame(loop);toast(t('tResumed'),'info');return;}
  recordedData=[];initState();simRunning=true;simPaused=false;lastTs=null;
  document.getElementById('results-panel').classList.add('visible');
  updatePauseBtn();animId=requestAnimationFrame(loop);toast(t('tLaunched'),'success');
});
document.getElementById('btn-pause').addEventListener('click',()=>{
  if(!simRunning)return;simPaused=!simPaused;
  if(simPaused){if(animId){cancelAnimationFrame(animId);animId=null;}lastTs=null;toast(t('tPaused'),'warn');}
  else{lastTs=null;animId=requestAnimationFrame(loop);toast(t('tResumed'),'info');}
  updatePauseBtn();
});
document.getElementById('btn-reset').addEventListener('click',()=>{doReset();toast(t('tReset'),'info');});

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleLoi(h){h.closest('.loi-card').classList.toggle('open');}
function resizeAll(){
  if(!cur3D){resize2D();if(!simRunning)drawIdle2D();}
  else if(TR3.renderer){
    const w=document.getElementById('canvas-wrap'),W=w.clientWidth,H=w.clientHeight;
    TR3.renderer.setSize(W,H);TR3.camera.aspect=W/H;TR3.camera.updateProjectionMatrix();
  }
}
window.addEventListener('resize',()=>setTimeout(resizeAll,100));

function exportRapport(type){
  if(type==='csv'){
    if(!recordedData.length){toast(t('tNoData'),'warn');return;}
    const p=gP();
    const head=`SimLab â€” Rapport CinÃ©matique (${currentMode.toUpperCase()})\nAuteur: Edmond Atinzoun TCHOKPON â€” UAC BÃ©nin â€” atinzlab.pages.dev\nDate: ${new Date().toLocaleDateString('fr-FR')}\nMode: ${currentMode} | v0=${p.v0}m/s | angle=${p.angle}Â° | g=${p.g}m/sÂ²\n\nt(s),x(m),y(m),vx(m/s),vy(m/s),v(m/s)`;
    const blob=new Blob([head+'\n'+recordedData.map(r=>`${r.t},${r.x},${r.y},${r.vx},${r.vy},${r.v}`).join('\n')],{type:'text/csv'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`simlab_cinematique_${currentMode}_${Date.now()}.csv`;a.click();toast(t('tCsv'),'success');
  } else toast('Ctrl+P pour imprimer en PDF','info');
}
function takeScreenshot(){
  const src=cur3D?document.getElementById('threeCanvas'):cv;
  const tmp=document.createElement('canvas');tmp.width=src.width||src.clientWidth;tmp.height=src.height||src.clientHeight;
  const tc=tmp.getContext('2d');tc.fillStyle='#111827';tc.fillRect(0,0,tmp.width,tmp.height);tc.drawImage(src,0,0);
  const a=document.createElement('a');a.href=tmp.toDataURL('image/png');a.download=`simlab_${Date.now()}.png`;a.click();toast(t('tShot'),'success');
}
function clearData(){recordedData=[];toast(t('tCleared'),'info');}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setTimeout(()=>{resize2D();drawIdle2D();applyLang();},80);
</script>
</body>
</html>
